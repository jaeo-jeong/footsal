<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>젓자FC 팀 짜기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }


        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .player-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .player-name {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .player-fields {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .field-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .delete-btn {
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .add-player-form {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .teams-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }

        .team-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .team-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .team-players {
            list-style: none;
        }

        .team-player {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info {
            display: flex;
            flex-direction: column;
        }

        .player-tier {
            font-size: 0.85em;
            opacity: 0.9;
        }


        .tier-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 5px;
        }

        .tier-S { background: #ff6b6b; }
        .tier-Aplus { background: #ffa500; }
        .tier-A { background: #ffd93d; }
        .tier-B { background: #6bcf7f; }
        .tier-C { background: #4ecdc4; }
        .tier-D { background: #95a5a6; }

        .tier-table {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .tier-table-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .tier-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tier-item {
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 15px;
        }

        .tier-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .tier-item-label {
            font-size: 1.3em;
            font-weight: 700;
        }

        .tier-item-count {
            font-size: 0.9em;
            color: #666;
            margin-left: auto;
        }

        .tier-item-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tier-player-name {
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
            color: #333;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .players-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚽ 젓자FC</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="resetToDefault()" style="background: #dc3545; color: white;">
                초기값으로 되돌리기
            </button>
        </div>

        <div class="tier-table">
            <div class="tier-table-title">티어 표</div>
            <div class="tier-list" id="tierList"></div>
        </div>

        <div class="section">
            <h2 class="section-title">선수 관리</h2>
            
            <div class="add-player-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>이름</label>
                        <input type="text" id="newPlayerName" placeholder="선수 이름">
                    </div>
                    <div class="form-group">
                        <label>티어</label>
                        <select id="newPlayerTier">
                            <option value="S">S</option>
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="B" selected>B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="addPlayer()">추가</button>
                </div>
            </div>

            <div class="players-grid" id="playersGrid"></div>
        </div>

        <div class="section">
            <h2 class="section-title">팀 구성</h2>
            <div class="controls">
                <button class="btn btn-secondary" onclick="selectAllPlayers()">전체 선택</button>
                <button class="btn btn-secondary" onclick="deselectAllPlayers()">전체 해제</button>
                <button class="btn btn-primary" onclick="generateFutsalTeams()">풋살팀 구성</button>
                <button class="btn btn-primary" onclick="generateSoccerTeams()">축구팀 구성</button>
            </div>
            <div class="teams-container" id="teamsContainer"></div>
        </div>
    </div>

    <script>
        // 티어 가중치 (높을수록 강함)
        const tierWeights = {
            'S': 6,
            'A+': 5,
            'A': 4,
            'B': 3,
            'C': 2,
            'D': 1
        };

        // localStorage 키
        const STORAGE_KEY = 'jeotjaFcPlayers';

        // 기본 선수 데이터
        const defaultPlayers = [
            { name: '정재오', tier: 'B' },
            { name: '강신재', tier: 'B' },
            { name: '장건호', tier: 'B' },
            { name: '김관영', tier: 'B' },
            { name: '김상욱', tier: 'B' },
            { name: '김승현', tier: 'B' },
            { name: '김태연', tier: 'B' },
            { name: '김동현', tier: 'B' },
            { name: '문용혁', tier: 'B' },
            { name: '문찬우', tier: 'B' },
            { name: '문태영', tier: 'B' },
            { name: '박찬영', tier: 'B' },
            { name: '박찬혁', tier: 'B' },
            { name: '배기정', tier: 'B' },
            { name: '하상우', tier: 'B' },
            { name: '김성호', tier: 'B' },
            { name: '신현우', tier: 'B' },
            { name: '옥준혁', tier: 'B' },
            { name: '우승훈', tier: 'B' },
            { name: '이도경', tier: 'B' },
            { name: '이신원', tier: 'B' },
            { name: '이준순', tier: 'B' },
            { name: '이창준', tier: 'B' },
            { name: '장재혁', tier: 'B' },
            { name: '정기헌', tier: 'B' },
            { name: '정우진', tier: 'B' },
            { name: '전근우', tier: 'B' },
            { name: '전은호', tier: 'B' }
        ];

        // 선수 데이터 로드 (localStorage에서 불러오기)
        function loadPlayers() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // 저장된 데이터가 있으면 사용, 없으면 기본 데이터 사용
                    const loadedPlayers = parsed.length > 0 ? parsed : defaultPlayers;
                    // 기존 데이터에서 position 필드 제거 (하위 호환성)
                    const cleanedPlayers = loadedPlayers.map(p => {
                        const { position, ...rest } = p;
                        return rest;
                    });
                    // 이름 기준으로 정렬
                    cleanedPlayers.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                    return cleanedPlayers;
                }
            } catch (e) {
                console.error('데이터 로드 실패:', e);
            }
            // 기본 데이터도 정렬하여 반환
            const sortedDefault = [...defaultPlayers].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            return sortedDefault;
        }

        // 선수 데이터 저장 (localStorage에 저장)
        function savePlayers() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
            } catch (e) {
                console.error('데이터 저장 실패:', e);
            }
        }

        // 선수 데이터 초기화
        let players = loadPlayers();
        
        // 선택된 선수 추적 (선수 이름을 키로 사용)
        let selectedPlayers = new Set();

        // 한국어 이름 정렬 함수 (성 기준 가나다 순)
        function sortPlayersByName() {
            players.sort((a, b) => {
                // 첫 글자(성)를 기준으로 정렬
                return a.name.localeCompare(b.name, 'ko');
            });
        }

        // 선수 목록 렌더링
        function renderPlayers() {
            // 이름 기준으로 정렬
            sortPlayersByName();
            
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.style.cursor = 'pointer';
                const isSelected = selectedPlayers.has(player.name);
                
                // 카드 클릭 이벤트 추가
                card.onclick = function(e) {
                    // 체크박스나 삭제 버튼 클릭 시에는 기본 동작 유지
                    if (e.target.type === 'checkbox' || e.target.classList.contains('btn') || e.target.tagName === 'SELECT') {
                        return;
                    }
                    // 카드 클릭 시 체크박스 토글
                    const checkbox = card.querySelector('.player-checkbox');
                    checkbox.checked = !checkbox.checked;
                    togglePlayerSelection(player.name, checkbox.checked);
                };
                
                // 정렬 후 실제 인덱스 찾기
                const actualIndex = players.findIndex(p => p.name === player.name);
                
                card.innerHTML = `
                    <div class="player-name">
                        <input type="checkbox" class="player-checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="togglePlayerSelection('${player.name}', this.checked)"
                               onclick="event.stopPropagation()">
                        ${player.name}
                    </div>
                    <div class="player-fields">
                        <div class="field-group">
                            <label>티어</label>
                            <select onchange="updatePlayer(${actualIndex}, 'tier', this.value)" onclick="event.stopPropagation()">
                                <option value="S" ${player.tier === 'S' ? 'selected' : ''}>S</option>
                                <option value="A+" ${player.tier === 'A+' ? 'selected' : ''}>A+</option>
                                <option value="A" ${player.tier === 'A' ? 'selected' : ''}>A</option>
                                <option value="B" ${player.tier === 'B' ? 'selected' : ''}>B</option>
                                <option value="C" ${player.tier === 'C' ? 'selected' : ''}>C</option>
                                <option value="D" ${player.tier === 'D' ? 'selected' : ''}>D</option>
                            </select>
                        </div>
                        <button class="btn btn-danger delete-btn" onclick="event.stopPropagation(); deletePlayer(${actualIndex})">삭제</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // 티어표도 업데이트
            renderTierTable();
        }

        // 선수 선택 토글
        function togglePlayerSelection(playerName, isChecked) {
            if (isChecked) {
                selectedPlayers.add(playerName);
            } else {
                selectedPlayers.delete(playerName);
            }
        }

        // 전체 선택
        function selectAllPlayers() {
            players.forEach(player => {
                selectedPlayers.add(player.name);
            });
            renderPlayers();
        }

        // 전체 해제
        function deselectAllPlayers() {
            selectedPlayers.clear();
            renderPlayers();
        }

        // 초기값으로 되돌리기
        function resetToDefault() {
            if (confirm('모든 선수 데이터를 초기 상태로 되돌리시겠습니까?\n(추가/수정/삭제한 모든 내용이 초기값으로 복원됩니다)')) {
                // localStorage 초기화
                localStorage.removeItem(STORAGE_KEY);
                
                // 선수 데이터를 기본값으로 복원
                players = defaultPlayers.map(p => ({ ...p })); // 깊은 복사
                
                // 선택된 선수 목록 초기화
                selectedPlayers.clear();
                
                // 저장 및 렌더링
                savePlayers();
                renderPlayers();
                
                alert('초기값으로 복원되었습니다.');
            }
        }

        // 티어표 렌더링
        function renderTierTable() {
            const tierList = document.getElementById('tierList');
            tierList.innerHTML = '';

            // 티어 순서
            const tierOrder = ['S', 'A+', 'A', 'B', 'C', 'D'];
            
            tierOrder.forEach(tier => {
                const tierPlayers = players.filter(p => p.tier === tier);
                
                const tierItem = document.createElement('div');
                tierItem.className = 'tier-item';
                
                tierItem.innerHTML = `
                    <div class="tier-item-header">
                        <span class="tier-badge tier-${tier.replace('+', 'plus')} tier-item-label">${tier}</span>
                        <span class="tier-item-count">${tierPlayers.length}명</span>
                    </div>
                    <div class="tier-item-players">
                        ${tierPlayers.length > 0 
                            ? tierPlayers.map(p => `<span class="tier-player-name">${p.name}</span>`).join('')
                            : '<span class="tier-player-name" style="color: #999;">선수 없음</span>'
                        }
                    </div>
                `;
                tierList.appendChild(tierItem);
            });
        }

        // 선수 추가
        function addPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            const tier = document.getElementById('newPlayerTier').value;

            if (!name) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (players.some(p => p.name === name)) {
                alert('이미 존재하는 선수입니다.');
                return;
            }

            players.push({ name, tier });
            // 새로 추가된 선수는 체크 해제 상태 (자동 선택 안 함)
            document.getElementById('newPlayerName').value = '';
            savePlayers(); // 저장
            renderPlayers();
        }

        // 선수 정보 업데이트
        function updatePlayer(index, field, value) {
            players[index][field] = value;
            savePlayers(); // 저장
            renderTierTable(); // 티어표 업데이트
        }

        // 선수 삭제
        function deletePlayer(index) {
            const playerName = players[index].name;
            if (confirm(`${playerName} 선수를 삭제하시겠습니까?`)) {
                // 선택 목록에서도 제거
                selectedPlayers.delete(playerName);
                players.splice(index, 1);
                savePlayers(); // 저장
                renderPlayers();
            }
        }

        // 풋살팀 구성 규칙
        function getFutsalTeamSizes(totalPlayers) {
            const rules = {
                12: [6, 6],
                13: [7, 6],
                14: [7, 7],
                15: [5, 5, 5],
                16: [8, 8],
                17: [6, 6, 5],
                18: [6, 6, 6],
                19: [7, 6, 6],
                20: [7, 7, 6],
                21: [7, 7, 7],
                22: [6, 6, 5, 5],
                23: [6, 6, 6, 5],
                24: [6, 6, 6, 6],
                25: [7, 6, 6, 6],
                26: [7, 7, 6, 6],
                27: [7, 7, 7, 6],
                28: [7, 7, 7, 7]
            };
            
            if (rules[totalPlayers]) {
                return rules[totalPlayers];
            }
            
            // 10-11명인 경우 기본 처리 (2팀)
            if (totalPlayers < 12) {
                const teamSize = Math.floor(totalPlayers / 2);
                const remainder = totalPlayers % 2;
                if (remainder === 0) {
                    return [teamSize, teamSize];
                } else {
                    return [teamSize + 1, teamSize];
                }
            }
            
            return null;
        }

        // 축구팀 구성 규칙 (2팀으로 나누기)
        function getSoccerTeamSizes(totalPlayers) {
            const teamSize = Math.floor(totalPlayers / 2);
            const remainder = totalPlayers % 2;
            if (remainder === 0) {
                return [teamSize, teamSize];
            } else {
                return [teamSize + 1, teamSize];
            }
        }

        // 풋살팀 구성 생성
        function generateFutsalTeams() {
            // 선택된 선수들만 필터링
            const selectedPlayersList = players.filter(p => selectedPlayers.has(p.name));
            const totalPlayers = selectedPlayersList.length;
            
            if (totalPlayers < 10) {
                alert('최소 10명의 선수를 선택해주세요.');
                return;
            }

            // 29명 이상일 때 경고
            if (totalPlayers >= 29) {
                alert('그냥 축구를 하세요');
                return;
            }

            // 총 인원에 따른 팀 크기 결정
            const teamSizes = getFutsalTeamSizes(totalPlayers);
            
            if (!teamSizes) {
                alert('풋살팀 구성이 불가능한 인원 수입니다.');
                return;
            }
            
            // 선택된 선수들을 매번 랜덤하게 섞기 (새로운 팀 구성을 위해)
            const shuffledList = [...selectedPlayersList].sort(() => Math.random() - 0.5);

            // 최적 팀 찾기 (최대 200번 시도, 매번 새로운 랜덤 시드)
            let bestTeams = null;
            let bestDiff = Infinity;

            for (let attempt = 0; attempt < 200; attempt++) {
                // 매 시도마다 선수 목록을 다시 섞기
                const reShuffledList = [...shuffledList].sort(() => Math.random() - 0.5);
                
                const teams = createBalancedTeams(teamSizes, reShuffledList);
                if (teams) {
                    const diff = calculateTeamDifference(teams);
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        bestTeams = teams;
                        // 완벽한 밸런스면 중단
                        if (diff === 0) break;
                    }
                }
            }

            if (!bestTeams) {
                alert('팀 구성을 실패했습니다. 선수 수를 확인해주세요.');
                return;
            }

            renderTeams(bestTeams, teamSizes);
        }

        // 축구팀 구성 생성
        function generateSoccerTeams() {
            // 선택된 선수들만 필터링
            const selectedPlayersList = players.filter(p => selectedPlayers.has(p.name));
            const totalPlayers = selectedPlayersList.length;
            
            if (totalPlayers < 2) {
                alert('최소 2명의 선수를 선택해주세요.');
                return;
            }

            // 총 인원에 따른 팀 크기 결정 (2팀으로 나누기)
            const teamSizes = getSoccerTeamSizes(totalPlayers);
            
            // 선택된 선수들을 매번 랜덤하게 섞기 (새로운 팀 구성을 위해)
            const shuffledList = [...selectedPlayersList].sort(() => Math.random() - 0.5);

            // 최적 팀 찾기 (최대 200번 시도, 매번 새로운 랜덤 시드)
            let bestTeams = null;
            let bestDiff = Infinity;

            for (let attempt = 0; attempt < 200; attempt++) {
                // 매 시도마다 선수 목록을 다시 섞기
                const reShuffledList = [...shuffledList].sort(() => Math.random() - 0.5);
                
                const teams = createBalancedTeams(teamSizes, reShuffledList);
                if (teams) {
                    const diff = calculateTeamDifference(teams);
                    if (diff < bestDiff) {
                        bestDiff = diff;
                        bestTeams = teams;
                        // 완벽한 밸런스면 중단
                        if (diff === 0) break;
                    }
                }
            }

            if (!bestTeams) {
                alert('팀 구성을 실패했습니다. 선수 수를 확인해주세요.');
                return;
            }

            renderTeams(bestTeams, teamSizes);
        }

        // 밸런스 있는 팀 생성
        function createBalancedTeams(teamSizes, playerList) {
            const numTeams = teamSizes.length;
            const teams = Array(numTeams).fill(null).map(() => []);
            const used = new Set();
            
            // 티어별로 선수 분류
            const tierOrder = ['S', 'A+', 'A', 'B', 'C', 'D'];
            
            // 티어별로 선수 분류
            function groupByTier(playerList) {
                const grouped = {};
                tierOrder.forEach(tier => {
                    grouped[tier] = playerList.filter(p => p.tier === tier && !used.has(p.name));
                });
                return grouped;
            }

            // 각 팀에 선수 배정 (티어 균등 분배 고려)
            for (let teamIdx = 0; teamIdx < numTeams; teamIdx++) {
                const teamSize = teamSizes[teamIdx];
                
                while (teams[teamIdx].length < teamSize) {
                    const playersByTier = groupByTier(playerList);
                    let assigned = false;
                    
                    // 티어 순서대로 라운드 로빈 방식으로 배정
                    for (const tier of tierOrder) {
                        const availablePlayers = playersByTier[tier];
                        if (availablePlayers.length > 0) {
                            const player = availablePlayers[0];
                            teams[teamIdx].push(player);
                            used.add(player.name);
                            assigned = true;
                            break;
                        }
                    }
                    
                    // 모든 티어에서 선수를 찾지 못한 경우 (이론적으로는 발생하지 않아야 함)
                    if (!assigned) {
                        // 남은 선수 중 아무나 배정
                        const remainingPlayer = playerList.find(p => !used.has(p.name));
                        if (remainingPlayer) {
                            teams[teamIdx].push(remainingPlayer);
                            used.add(remainingPlayer.name);
                        } else {
                            return null; // 선수가 부족함
                        }
                    }
                }
            }

            // 팀 크기 확인
            for (let i = 0; i < numTeams; i++) {
                if (teams[i].length !== teamSizes[i]) {
                    return null;
                }
            }

            // 티어 밸런스 최적화
            optimizeTierBalance(teams);

            return teams;
        }

        // 티어별 분배 개선 (특정 티어가 한 팀에 몰리지 않도록)
        function improveTierDistribution(teams) {
            const criticalTiers = ['S', 'A+', 'D'];
            const tierOrder = ['S', 'A+', 'A', 'B', 'C', 'D'];
            
            for (let iteration = 0; iteration < 200; iteration++) {
                let improved = false;
                
                // 각 티어별로 확인
                tierOrder.forEach(tier => {
                    const tierCounts = teams.map(team => 
                        team.filter(p => p.tier === tier).length
                    );
                    const maxCount = Math.max(...tierCounts);
                    const minCount = Math.min(...tierCounts);
                    
                    // 분배가 불균형하면 개선 시도
                    if (maxCount - minCount > 1 || (criticalTiers.includes(tier) && maxCount >= 2)) {
                        // 가장 많은 팀과 가장 적은 팀 찾기
                        const maxTeamIdx = tierCounts.indexOf(maxCount);
                        const minTeamIdx = tierCounts.indexOf(minCount);
                        
                        // 해당 티어 선수를 찾아서 교체 시도
                        const maxTeam = teams[maxTeamIdx];
                        const minTeam = teams[minTeamIdx];
                        
                        // 같은 티어가 아닌 선수와 교체
                        for (let i = 0; i < maxTeam.length; i++) {
                            if (maxTeam[i].tier === tier) {
                                for (let j = 0; j < minTeam.length; j++) {
                                    if (minTeam[j].tier !== tier) {
                                        // 교체 시도
                                        const temp = maxTeam[i];
                                        maxTeam[i] = minTeam[j];
                                        minTeam[j] = temp;
                                        
                                        // 개선되었는지 확인
                                        const newTierCounts = teams.map(team => 
                                            team.filter(p => p.tier === tier).length
                                        );
                                        const newMaxCount = Math.max(...newTierCounts);
                                        const newMinCount = Math.min(...newTierCounts);
                                        
                                        if (newMaxCount - newMinCount < maxCount - minCount) {
                                            improved = true;
                                            break;
                                        } else {
                                            // 되돌리기
                                            minTeam[j] = maxTeam[i];
                                            maxTeam[i] = temp;
                                        }
                                    }
                                }
                                if (improved) break;
                            }
                        }
                    }
                });
                
                if (!improved) break;
            }
        }

        // 티어 밸런스 최적화
        function optimizeTierBalance(teams) {
            function getTeamTierSum(team) {
                return team.reduce((sum, p) => sum + tierWeights[p.tier], 0);
            }

            function getTeamVariance(teams) {
                const sums = teams.map(team => getTeamTierSum(team));
                const avg = sums.reduce((a, b) => a + b, 0) / sums.length;
                const variance = sums.reduce((sum, s) => sum + Math.pow(s - avg, 2), 0) / sums.length;
                return variance;
            }

            // 먼저 티어별 분배 개선 (S, A+, D가 한 팀에 몰리지 않도록)
            improveTierDistribution(teams);

            // 여러 번 시도하여 전체 티어 합 밸런스 개선
            for (let iteration = 0; iteration < 150; iteration++) {
                const currentScore = calculateTeamDifference(teams);
                
                // 모든 팀 쌍에 대해 교체 시도
                let improved = false;
                
                for (let i = 0; i < teams.length; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        const team1 = teams[i];
                        const team2 = teams[j];
                        
                        // 모든 선수 교체 시도
                        for (const p1 of team1) {
                            for (const p2 of team2) {
                                if (p1.tier !== p2.tier) {
                                    // 교체 시도
                                    const idx1 = team1.indexOf(p1);
                                    const idx2 = team2.indexOf(p2);
                                    team1[idx1] = p2;
                                    team2[idx2] = p1;
                                    
                                    const newScore = calculateTeamDifference(teams);
                                    if (newScore < currentScore) {
                                        improved = true;
                                        break;
                                    } else {
                                        // 되돌리기
                                        team1[idx1] = p1;
                                        team2[idx2] = p2;
                                    }
                                }
                            }
                            if (improved) break;
                        }
                        
                        if (improved) break;
                    }
                    if (improved) break;
                }
                
                if (!improved) break;
            }
        }

        // 티어별 분배 점수 계산 (낮을수록 좋음)
        function calculateTierDistributionScore(teams) {
            const tierOrder = ['S', 'A+', 'A', 'B', 'C', 'D'];
            const criticalTiers = ['S', 'A+', 'D']; // 한 팀에 몰리면 안 되는 티어
            let score = 0;
            
            // 각 티어별로 팀 간 분배 확인
            tierOrder.forEach(tier => {
                const tierCounts = teams.map(team => 
                    team.filter(p => p.tier === tier).length
                );
                
                // 팀 간 분배의 분산 계산
                const avg = tierCounts.reduce((a, b) => a + b, 0) / tierCounts.length;
                const variance = tierCounts.reduce((sum, c) => sum + Math.pow(c - avg, 2), 0) / tierCounts.length;
                score += variance * 10; // 티어 분배 불균형 페널티
                
                // S, A+, D 티어는 한 팀에 몰리면 큰 페널티
                if (criticalTiers.includes(tier)) {
                    const maxCount = Math.max(...tierCounts);
                    const minCount = Math.min(...tierCounts);
                    if (maxCount - minCount > 1) {
                        score += (maxCount - minCount - 1) * 100; // 큰 페널티
                    }
                    // 한 팀에 2명 이상 몰리면 추가 페널티
                    if (maxCount >= 2) {
                        score += (maxCount - 1) * 50;
                    }
                }
            });
            
            return score;
        }

        // 팀 간 티어 차이 계산 (분산 기반 + 티어 분배)
        function calculateTeamDifference(teams) {
            const sums = teams.map(team => team.reduce((sum, p) => sum + tierWeights[p.tier], 0));
            const avg = sums.reduce((a, b) => a + b, 0) / sums.length;
            const variance = sums.reduce((sum, s) => sum + Math.pow(s - avg, 2), 0) / sums.length;
            
            // 티어 분배 점수 추가
            const tierDistributionScore = calculateTierDistributionScore(teams);
            
            return variance + tierDistributionScore;
        }

        // 팀 렌더링
        function renderTeams(teams, teamSizes) {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '';

            teams.forEach((team, index) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';
                
                const tierSum = team.reduce((sum, p) => sum + tierWeights[p.tier], 0);

                teamDiv.innerHTML = `
                    <div class="team-title">팀 ${index + 1} (${teamSizes[index]}명)</div>
                    <div class="team-stats">
                        <div>티어 합: ${tierSum}</div>
                    </div>
                    <ul class="team-players">
                        ${team.map(player => `
                            <li class="team-player">
                                <div class="player-info">
                                    <div>${player.name} <span class="tier-badge tier-${player.tier.replace('+', 'plus')}">${player.tier}</span></div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
                container.appendChild(teamDiv);
            });
        }

        // 초기 렌더링
        renderPlayers();
        renderTierTable();
    </script>
</body>
</html>
